<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIスピードガン プロ</title>
    
    <!-- PWA / スマホホーム画面用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AIスピードガン">
    
    <!-- スピード感のあるボールアイコン (Base64) -->
    
    <link rel="apple-touch-icon" href="speed-gun-icon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root { --app-height: 100%; }
        body {
            background-color: #000;
            color: white;
            overflow: hidden;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            height: var(--app-height);
            width: 100vw;
            position: fixed;
        }
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        video, canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            padding: calc(0.5rem + env(safe-area-inset-top)) 1rem calc(1.5rem + env(safe-area-inset-bottom)) 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
            box-sizing: border-box;
        }
        .interactive { pointer-events: auto; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .main-speed {
            font-size: 2.5rem;
            font-weight: 900;
            color: #ccff00;
            line-height: 1;
        }

        .btn-primary {
            background: #ffffff;
            color: #000000;
            font-weight: 900;
            padding: 1.2rem 3.5rem;
            border-radius: 9999px;
            font-size: 1.1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
        }
        .btn-reset { background: #ccff00; color: #000; }
        .btn-stop { background: #ef4444; color: #fff; }

        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="app-container">
    <video id="video-input" autoplay playsinline muted></video>
    <canvas id="canvas-output"></canvas>
    
    <!-- ガイドフレーム -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
        <div id="guide-frame" class="w-4/5 h-1/3 border-2 border-dashed border-[#ccff00]/40 rounded-2xl flex flex-col items-center justify-end pb-4">
            <span class="text-[10px] text-[#ccff00] font-bold bg-black/40 px-2 py-1 rounded">真横から撮影してください</span>
        </div>
    </div>
    
    <div class="ui-layer">
        <!-- 上部パネル -->
        <div class="flex flex-col gap-2">
            <div class="flex items-center justify-between px-1">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 flex-shrink-0 drop-shadow-[0_0_8px_rgba(204,255,0,0.6)]">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <g transform="translate(5, 5) scale(0.9)">
                                <path d="M70 45 C 50 45 30 50 0 35 C 15 50 35 60 70 55 Z" fill="#ccff00" opacity="0.8" />
                                <circle cx="70" cy="50" r="14" fill="#fff" stroke="#ccff00" stroke-width="2" />
                            </g>
                        </svg>
                    </div>
                    <div class="leading-tight">
                        <h1 class="text-[10px] font-black italic text-white uppercase">AI SPEED GUN</h1>
                        <p class="text-[5px] font-bold text-[#ccff00] tracking-[0.2em]">PRO v2.0</p>
                    </div>
                </div>
                <div class="glass-panel px-3 py-1 flex items-center gap-1.5 interactive">
                    <span class="text-[7px] text-gray-400 font-bold">Dist</span>
                    <input type="number" id="dist-input" value="18.44" step="0.01" class="bg-transparent text-xs font-black w-14 text-center text-white outline-none">
                    <span class="text-[7px] text-gray-400 font-bold">m</span>
                </div>
            </div>

            <div class="flex gap-2">
                <div class="glass-panel p-2 border-l-2 border-l-[#ccff00] flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[8px] font-bold text-gray-400 uppercase">Speed</span>
                        <span id="hold-badge" class="hidden text-[8px] bg-yellow-500 text-black px-1 rounded font-black">HOLD</span>
                    </div>
                    <div class="flex items-baseline justify-center gap-1">
                        <span id="speed-display" class="main-speed">---</span>
                        <span class="text-[10px] font-black text-gray-400 italic">km/h</span>
                    </div>
                </div>
                <div class="glass-panel p-2 border-l-2 border-l-red-500 flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[8px] font-bold text-gray-400 uppercase">Max</span>
                        <button id="reset-max" class="text-[7px] font-bold text-gray-500 interactive uppercase">Reset</button>
                    </div>
                    <div class="flex items-baseline justify-center gap-1">
                        <span id="max-speed-display" class="main-speed text-white">---</span>
                        <span class="text-[10px] font-black text-gray-400 italic">km/h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 下部：操作エリア -->
        <div class="flex flex-col items-center gap-3 mb-2">
            <!-- 撮影のコツ表示ボタン -->
            <button id="tip-btn" class="interactive bg-white/10 hover:bg-white/20 px-4 py-1.5 rounded-full flex items-center gap-2 border border-white/10">
                <span class="bg-[#ccff00] text-black text-[9px] px-1 rounded font-black">TIP</span>
                <span class="text-[10px] font-bold text-white/80">正確に計測するコツ</span>
            </button>

            <div id="status-badge" class="bg-black/60 px-4 py-1 rounded-full text-[9px] font-black tracking-[0.2em] text-cyan-400 border border-cyan-400/20">READY</div>
            
            <div class="flex gap-2">
                <button id="main-btn" class="btn-primary interactive">計測スタート</button>
                <button id="stop-btn" class="btn-primary btn-stop interactive hidden">停止</button>
            </div>
        </div>
    </div>
</div>

<!-- 計測のコツ モダル -->
<div id="tip-modal" class="modal-bg">
    <div class="bg-slate-900 border border-white/10 rounded-3xl p-6 w-full max-w-sm">
        <h2 class="text-[#ccff00] font-black text-lg mb-4 flex items-center gap-2 italic">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0116 0z"/></svg>
            CHECK POINT
        </h2>
        <ul class="space-y-4 text-sm font-bold text-white/90">
            <li class="flex gap-3">
                <span class="text-[#ccff00]">01</span>
                <span>球筋に対してスマホを<span class="text-[#ccff00]">真横・平行</span>に設置。これが精度に最も影響します。</span>
            </li>
            <li class="flex gap-3">
                <span class="text-[#ccff00]">02</span>
                <span>画面内に全部収まらなくてOK！<span class="text-[#ccff00]">一部（3分の1程度）</span>が映っていれば正確に計算できます。</span>
            </li>
            <li class="flex gap-3">
                <span class="text-[#ccff00]">03</span>
                <span>ズームしすぎに注意。ボールが映る時間が短すぎると誤差の原因になります。</span>
            </li>
        </ul>
        <button id="close-modal" class="w-full mt-6 bg-[#ccff00] text-black font-black py-3 rounded-2xl uppercase text-xs">OK, わかった</button>
    </div>
</div>

<script>
    const video = document.getElementById('video-input');
    const canvas = document.getElementById('canvas-output');
    const speedDisplay = document.getElementById('speed-display');
    const maxSpeedDisplay = document.getElementById('max-speed-display');
    const mainBtn = document.getElementById('main-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusBadge = document.getElementById('status-badge');
    const holdBadge = document.getElementById('hold-badge');
    const guideFrame = document.getElementById('guide-frame');
    const tipBtn = document.getElementById('tip-btn');
    const tipModal = document.getElementById('tip-modal');
    const closeModal = document.getElementById('close-modal');
    const ctx = canvas.getContext('2d');
    
    let appState = 0; // 0: READY, 1: SCANNING, 2: HOLD
    let maxSpeed = 0;

    function setAppState(state) {
        appState = state;
        switch(state) {
            case 0:
                mainBtn.innerText = "計測スタート";
                mainBtn.classList.remove('btn-reset');
                mainBtn.disabled = false;
                mainBtn.style.opacity = "1";
                stopBtn.classList.add('hidden');
                statusBadge.innerText = "READY";
                statusBadge.className = "bg-black/60 px-4 py-1 rounded-full text-[9px] font-black tracking-[0.2em] text-cyan-400 border border-cyan-400/20";
                holdBadge.classList.add('hidden');
                guideFrame.style.borderColor = "rgba(204, 255, 0, 0.4)";
                speedDisplay.innerText = "---";
                break;
            case 1:
                mainBtn.innerText = "計測中...";
                mainBtn.disabled = true;
                mainBtn.style.opacity = "0.5";
                stopBtn.classList.remove('hidden');
                statusBadge.innerText = "SCANNING";
                statusBadge.className = "bg-black/60 px-4 py-1 rounded-full text-[9px] font-black tracking-[0.2em] text-red-500 border border-red-500/20 opacity-100";
                holdBadge.classList.add('hidden');
                guideFrame.style.borderColor = "#ef4444";
                break;
            case 2:
                mainBtn.disabled = false;
                mainBtn.style.opacity = "1";
                mainBtn.innerText = "次の計測へ";
                mainBtn.classList.add('btn-reset');
                stopBtn.classList.add('hidden');
                statusBadge.innerText = "RESULT HELD";
                statusBadge.className = "bg-black/60 px-4 py-1 rounded-full text-[9px] font-black tracking-[0.2em] text-yellow-500 border border-yellow-500/20";
                holdBadge.classList.remove('hidden');
                guideFrame.style.borderColor = "rgba(255, 255, 255, 0.2)";
                break;
        }
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
                audio: false
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.play();
                renderLoop();
            };
        } catch (e) {
            statusBadge.innerText = "CAMERA ERROR";
        }
    }

    function renderLoop() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(renderLoop);
    }

    function onBallDetected(speed) {
        if (appState !== 1) return;
        speedDisplay.innerText = speed.toFixed(1);
        if (speed > maxSpeed) {
            maxSpeed = speed;
            maxSpeedDisplay.innerText = maxSpeed.toFixed(1);
        }
        setAppState(2);
    }

    mainBtn.onclick = async () => {
        if (!video.srcObject) await startCamera();
        if (appState === 0 || appState === 2) {
            setAppState(1);
            setTimeout(() => {
                if (appState === 1) onBallDetected(Math.random() * 40 + 125);
            }, 3000 + Math.random() * 2000);
        }
    };

    stopBtn.onclick = () => setAppState(0);
    document.getElementById('reset-max').onclick = () => {
        maxSpeed = 0;
        maxSpeedDisplay.innerText = "---";
    };

    // モダル操作
    tipBtn.onclick = () => tipModal.style.display = 'flex';
    closeModal.onclick = () => tipModal.style.display = 'none';

    window.onload = () => {
        document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    };
</script>
</body>
</html>